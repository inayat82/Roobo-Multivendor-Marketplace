"use strict";(()=>{var e={};e.id=397,e.ids=[397],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3573:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>m,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>d,staticGenerationAsyncStorage:()=>u});var a={};t.r(a),t.d(a,{GET:()=>l});var o=t(3278),s=t(5002),n=t(4877),i=t(1309);async function l(e){console.log("OAuth callback received:",e.url);let{getDatabase:r,users:a,vendors:o}=await t.e(554).then(t.bind(t,7554)),s=r();if(!s)return console.error("Database not available"),i.NextResponse.json({error:"Database not available"},{status:500});let n=new URL(e.url),l=n.searchParams.get("code"),c=n.searchParams.get("shop");if(n.searchParams.get("state"),!l||!c)return console.error("Missing OAuth parameters:",{code:!!l,shop:c}),i.NextResponse.json({error:"Missing OAuth parameters"},{status:400});try{let e=await fetch(`https://${c}/admin/oauth/access_token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:process.env.SHOPIFY_API_KEY,client_secret:process.env.SHOPIFY_API_SECRET,code:l})});if(!e.ok)throw Error("Failed to exchange code for access token");let r=await e.json();console.log("Access token received for shop:",c);let{access_token:t,scope:n}=r,p=await s.query.users.findFirst({where:(e,{and:r,eq:t})=>r(t(e.shopifyStoreId,c),t(e.role,"super_admin"))});if(p)console.log("Existing Super Admin user found:",p.id);else{let[e]=await s.insert(a).values({shopifyStoreId:c,email:`admin@${c}`,role:"super_admin",status:"active"}).returning();console.log("Created new Super Admin user:",e.id),await s.insert(o).values({userId:e.id,shopId:c,status:"active",approvedAt:new Date,approvedBy:e.id}),console.log("Created vendor record for Super Admin")}let u=`${process.env.APP_URL}/dashboard?shop=${c}&installed=true`;return console.log("Redirecting to dashboard:",u),i.NextResponse.redirect(u)}catch(r){console.error("Shopify callback error:",r);let e=r instanceof Error?r.message:"Unknown error";return i.NextResponse.json({error:"Callback failed",details:e},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/shopify/callback/route",pathname:"/api/auth/shopify/callback",filename:"route",bundlePath:"app/api/auth/shopify/callback/route"},resolvedPagePath:"C:\\Users\\inaya\\OneDrive\\Desktop\\Project 2025\\pos-app-26-Aug-9AM (2)\\multivendor-marketplace\\app\\api\\auth\\shopify\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:u,serverHooks:d}=c,h="/api/auth/shopify/callback/route";function m(){return(0,n.patchFetch)({serverHooks:d,staticGenerationAsyncStorage:u})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[787,833],()=>t(3573));module.exports=a})();